import videojs from"video.js";import Hlsjs from"hls.js";if("undefined"!==typeof window)window.videojs=videojs;var registerSourceHandler=function(e){var r={};function n(n,t){t.name_="nuevoHlsjs";var i,o=t.el(),a={},s=null,l=null,u=null,d=null,f=null,c=null,v=e(t.options_.playerId),g=v.qualities;if(v.qualities)t.hls={};var p=!1;function h(e){if(void 0!==r[e])for(var n=0;n<r[e].length;n++)r[e][n](v,i)}function E(e){if(1===a[Hlsjs.ErrorTypes.MEDIA_ERROR]){console.info("trying to recover media error");i.recoverMediaError()}else if(2===a[Hlsjs.ErrorTypes.MEDIA_ERROR]){console.info("2nd try to recover media error (by swapping audio codec");i.swapAudioCodec();i.recoverMediaError()}else if(a[Hlsjs.ErrorTypes.MEDIA_ERROR]>1){t.error=function(){return e};t.trigger("error")}}function b(e,r){var n={message:"HLS.js error: "+r.type+" - fatal: "+r.fatal+" - "+r.details};console.error(n.message);if(a[r.type])a[r.type]+=1;else a[r.type]=1;if(r.fatal)switch(r.type){case Hlsjs.ErrorTypes.NETWORK_ERROR:console.info("bubbling network error up to VIDEOJS");n.code=2;t.error=function(){return n};t.trigger("error");break;case Hlsjs.ErrorTypes.MEDIA_ERROR:n.code=3;E(n);break;default:i.destroy();console.info("bubble error up to VIDEOJS");t.error=function(){return n};t.trigger("error")}}function m(e){}function y(e){if(e.height)return e.height+"p";else if(e.width)return Math.round(9*e.width/16)+"p";else if(e.bitrate)return e.bitrate/1e3+"kbps";return 0}function w(e,r){if(v.qualities.length>0){if("boolean"===typeof r)v.qualities[e].enabled=r;return v.qualities[e].enabled}return!1}function k(){if(l){v.qualities=[];g=v.qualities;t.hls={};for(var e=0;e<l.levels.length;e++){var r=l.levels[e],n="vjs-"+e,i={id:n,index:n,label:n,width:r.width,height:r.height,bandwidth:r.bitrate,bitrate:r.bitrate,enabled:!1};i.enabled=w.bind(this,e);g.push(i)}}}function T(e,r){if(v.qualities.length>0){v.qualityIndex=r.level;v.trigger("qualityChange")}}function R(){if(l){var e=[];if(l.levels.length>1){var r={id:-1,label:"auto",selected:-1===i.manualLevel};e.push(r)}l.levels.forEach(function(r,n){var t={};t.id=n;t.selected=n===i.manualLevel;t.label=y(r);e.push(t)});v.qualities=g;var n={qualityData:{video:e},qualitySwitchCallback:m};t.trigger("loadedqualitydata",n);o.removeEventListener("playing",R);v.trigger("levelsLoaded")}}function j(){for(var e=t.audioTracks(),r=0;r<e.length;r++)if(e[r].enabled){i.audioTrack=r;break}}function _(){var r=i.audioTracks,n=t.audioTracks();if(r.length>1&&0===n.length){for(var o=0;o<r.length;o++)n.addTrack(new e.AudioTrack({id:o,kind:"alternative",label:r[o].name||r[o].lang,language:r[o].lang,enabled:o===i.audioTrack}));n.addEventListener("change",j)}}function L(e){return e.label?e.label:e.language}function H(e,r){return L(e)===L(r)&&e.kind===r.kind}function O(){for(var e=v.textTracks(),r=null,n=0;n<e.length;n++)if("showing"===e[n].mode){r=e[n];break}for(var t=o.textTracks,i=0;i<t.length;i++)if("subtitles"===t[i].kind||"captions"===t[i].kind)t[i].mode=r&&H(t[i],r)?"showing":"disabled"}function C(){i.startLoad(-1);o.removeEventListener("play",C)}function D(e){for(var r={},n=Object.keys(e),t=0;t<n.length;t++)r[n[t]]=e[n[t]];return r}function S(e){for(var r=[],n=0;n<e.length;n++)if("subtitles"===e[n].kind||"captions"===e[n].kind)r.push(e[n]);return r}function A(){for(var e=S(o.textTracks),r=v.textTracks(),n=0;n<e.length;n++){for(var t=!1,i=0;i<r.length;i++)if(H(e[n],r[i])){t=!0;break}if(!t){var a=e[n];v.addRemoteTextTrack({kind:a.kind,label:L(a),language:a.language,srclang:a.language},!1)}}O();if(!p){r.addEventListener("change",O);p=!0}}function x(e,r){l=r;k()}function M(e){return{newCue:function(r,n,t,i){for(var o,a,s,l=window.VTTCue||window.TextTrackCue,u=0;u<i.rows.length;u++){s="";if(!(o=i.rows[u]).isEmpty()){for(var d=0;d<o.chars.length;d++)s+=o.chars[d].uchar;a=new l(n,t,s.trim());if(null!=e&&"object"===typeof e)for(var f=Object.keys(e),c=0;c<f.length;c++)a[f[c]]=e[f[c]];r.addCue(a);if(t===n)r.addCue(new l(t+5,""))}}}}}function I(){var e=(v.srOptions_&&v.srOptions_.hlsjsConfig)||t.options_.hlsjsConfig;c=e?D(e):{};if(-1===["","auto"].indexOf(o.preload)&&!o.autoplay&&void 0===c.autoStartLoad)c.autoStartLoad=!1;var r=(v.srOptions_&&v.srOptions_.captionConfig)||t.options_.captionConfig;if(r)c.cueHandler=M(r);if(!1===c.autoStartLoad)o.addEventListener("play",C);var l="undefined"!==typeof InstallTrigger,g=!(!(window.chrome||!window.chrome.webstore)&&!window.chrome.runtime),p=g&&-1!==navigator.userAgent.indexOf("Edg");if(void 0===c.capLevelToPlayerSize)c.capLevelToPlayerSize=!0;if(void 0===c.smoothQualityChange)c.smoothQualityChange=!0;if(!0===c.capLevelToPlayerSize)if(l||g||p){if(!c.maxBufferLength)c.maxBufferLength=60;if(!c.maxMaxBufferLength)c.maxMaxBufferLength=60}o.addEventListener("playing",R);i=new Hlsjs(c);v.hlsjs=i;h("beforeinitialize");i.on(Hlsjs.Events.ERROR,function(e,r){b(e,r,t,a)});i.on(Hlsjs.Events.AUDIO_TRACKS_UPDATED,_);i.on(Hlsjs.Events.MANIFEST_PARSED,x);i.on(Hlsjs.Events.LEVEL_LOADED,function(e,r){if(c.liveSyncDuration)f=c.liveSyncDuration;else if(c.liveSyncDurationCount)f=c.liveSyncDurationCount*r.details.targetduration;u=r.details.live;d=r.details.totalduration;s=u?1/0:r.details.totalduration});i.once(Hlsjs.Events.FRAG_LOADED,function(){t.trigger("loadedmetadata")});i.on(Hlsjs.Events.LEVEL_SWITCHED,T);i.attachMedia(o);o.textTracks.addEventListener("addtrack",A);i.loadSource(n.src)}function q(){I()}this.duration=function(){return s||o.duration||0};this.seekable=function(){if(i.media){if(!u)return e.createTimeRanges(0,i.media.duration);var r=Math.round(i.media.duration-d),n=Math.round(i.media.duration-f);return e.createTimeRanges(r,n)}return e.createTimeRanges()};this.dispose=function(){o.removeEventListener("play",C);o.textTracks.removeEventListener("addtrack",A);o.removeEventListener("playing",R);v.textTracks().removeEventListener("change",O);p=!1;v.audioTracks().removeEventListener("change",j);i.destroy()};o.addEventListener("error",function(e){var r,n=e.currentTarget.error;switch(n.code){case n.MEDIA_ERR_ABORTED:r="You aborted the video playback";break;case n.MEDIA_ERR_DECODE:r="The video playback was aborted due to a corruption problem or because the video used features your browser did not support";E(n);break;case n.MEDIA_ERR_NETWORK:r="A network error caused the video download to fail part-way";break;case n.MEDIA_ERR_SRC_NOT_SUPPORTED:r="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:r=n.message}console.error("MEDIA_ERROR: ",r)});q()}n.addHook=function(e,n){r[e]=r[e]||[];r[e].push(n)};n.removeHook=function(e,n){if(void 0===r[e])return!1;var t=r[e].indexOf(n);if(-1===t)return!1;r[e].splice(t,1);return!0};if(Hlsjs.isSupported()){var t;if("function"===typeof e.getTech)t=e.getTech("Html5");else if("function"===typeof e.getComponent)t=e.getComponent("Html5");else{console.error("Not supported version if video.js");return}if(!t){console.error("Not supported version if video.js");return}t.registerSourceHandler({canHandleSource:function(e){var r,n=/\.m3u8/i;if(/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(e.type))r="probably";else if(n.test(e.src))r="maybe";else r="";return r},handleSource:function(e,r){if(r.hlsProvider)r.hlsProvider.dispose();r.hlsProvider=new n(e,r);return r.hlsProvider}},0);e.Html5Hlsjs=n}else console.warn("Hls.js is not supported in this browser!")};function nuevoHlsjsConfigHandler(e){var r=this;if(e){if(!r.srOptions_)r.srOptions_={};if(!r.srOptions_.hlsjsConfig)r.srOptions_.hlsjsConfig=e.hlsjsConfig;if(!r.srOptions_.captionConfig)r.srOptions_.captionConfig=e.captionConfig}}var registerConfigPlugin=function(e){(e.registerPlugin||e.plugin)("nuevoHls",nuevoHlsjsConfigHandler)};if("undefined"!==typeof window)if(window.videojs){registerConfigPlugin(window.videojs);registerSourceHandler(window.videojs)}