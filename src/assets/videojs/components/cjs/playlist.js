/* eslint-env node */function _interopDefault(e){return e&&"object"===typeof e&&"default"in e?e.default:e}var videojs=_interopDefault(require("video.js"));var first_play=!1;var first_item=!0;var validSeconds=function(e){return"number"===typeof e&&!isNaN(e)&&e>=0&&e<1/0};var reset=function(e){var r=e.playlist.autoadvance_;if(r.timeout)e.clearTimeout(r.timeout);if(r.trigger)e.off("ended",r.trigger);r.timeout=null;r.trigger=null};var setup=function e(r,t){reset(r);if(validSeconds(t)){r.playlist.autoadvance_.delay=t;r.playlist.autoadvance_.trigger=function(){var n=function(){return e(r,t)};r.one("play",n);r.playlist.autoadvance_.timeout=r.setTimeout(function(){reset(r);r.off("play",n);r.playlist.next()},1e3*t)};r.one("ended",r.playlist.autoadvance_.trigger)}else r.playlist.autoadvance_.delay=null};var playItem=function(e,r){var t=!e.paused()||e.ended();if(r.playlistItemId_)e.playlist.currentPlaylistItemId_=r.playlistItemId_;e.changeSrc(r);e.trigger("playlist_change",{id:r.playlistItemId_});if(!0!==first_play)first_play=!0;e.ready(function(){e.trigger("playlistitem",r.originalValue||r);e.trigger("playlist_newitem",{id:r.playlistItemId_});if(first_item)first_item=!1;if(t){var n=e.play();if("undefined"!==typeof n&&"function"===typeof n.then)n.then(null,function(){})}setup(e,e.playlist.autoadvance_.delay)});return e};var isItemObject=function(e){return!!e&&"object"===typeof e};var transformPrimitiveItems=function(e){var r=[];var t;e.forEach(function(e){if(!isItemObject(e))(t=Object(e)).originalValue=e;else t=e;r.push(t)});return r};var generatePlaylistItemId=function(e){var r=1;e.forEach(function(e){e.playlistItemId_=r++})};var indexInPlaylistItemIds=function(e,r){for(var t=0;t<e.length;t++)if(e[t].playlistItemId_===r)return t;return-1};var sourceEquals=function(e,r){var t=e;var n=r;if("object"===typeof e)t=e.src;if("object"===typeof r)n=r.src;if(/^\/\//.test(t))n=n.slice(n.indexOf("//"));if(/^\/\//.test(n))t=t.slice(t.indexOf("//"));return t===n};var indexInSources=function(e,r){for(var t=0;t<e.length;t++){var n=e[t].sources;if(Array.isArray(n))for(var i=0;i<n.length;i++){var a=n[i];if(a&&sourceEquals(a,r))return t}}return-1};function factory(e,r,t){if(void 0===t)t=0;var n=null;var i=!1;var a=e.playlist=function(r,t){if(void 0===t)t=0;if(i)throw new Error("do not call playlist() during a playlist change");if(Array.isArray(r)){var u=Array.isArray(n)?n.slice():null;var l=r.slice();if((n=l.slice()).filter(function(e){return isItemObject(e)}).length!==n.length)n=transformPrimitiveItems(n);generatePlaylistItemId(n);i=!0;i=!1;if(-1!==t)a.currentItem(t);if(u)e.setTimeout(function(){e.trigger("playlistchange")},0)}return n.map(function(e){return e.originalValue||e}).slice()};e.on("loadstart",function(){if(-1===a.currentItem())reset(e)});a.currentIndex_=-1;a.player_=e;a.autoadvance_={};a.repeat_=!1;a.currentPlaylistItemId_=null;a.currentItem=function(e){if(i)return a.currentIndex_;if("undefined"===a.currentIndex_)a.currentIndex_=0;if("number"===typeof e&&a.currentIndex_!==e&&e>=0&&e<n.length){a.currentIndex_=e;playItem(a.player_,n[a.currentIndex_]);return a.currentIndex_}var r=a.player_.currentSrc()||"";if(a.currentPlaylistItemId_){var t=indexInPlaylistItemIds(n,a.currentPlaylistItemId_);var u=n[t];if(u&&Array.isArray(u.sources)&&indexInSources([u],r)>-1){a.currentIndex_=t;return a.currentIndex_}a.currentPlaylistItemId_=null}a.currentIndex_=a.indexOf(r);return a.currentIndex_};a.contains=function(e){return-1!==a.indexOf(e)};a.indexOf=function(e){if("string"===typeof e)return indexInSources(n,e);var r=Array.isArray(e)?e:e.sources;for(var t=0;t<r.length;t++){var i=r[t];if("string"===typeof i)return indexInSources(n,i);else if(i.src)return indexInSources(n,i.src)}return-1};a.remove=function(r){if("number"===typeof r)if(r<n.length){e.removeFromPlaylist(r);n.splice(r,1)}};a.insert=function(r){if("undefined"!==typeof r.src||"undefined"!==typeof r.sources){e.addToPlaylist(r);n.push(r)}};a.insertAfter=function(r,t){if(("undefined"!==typeof r.src||"undefined"!==typeof r.sources)&&"number"===typeof t)if(t<=n.length&&t>-1){e.addToPlaylist(r,"after",t);n.splice(t+1,0,r)}};a.insertBefore=function(r,t){if(("undefined"!==typeof r.src||"undefined"!==typeof r.sources)&&"number"===typeof t)if(t<n.length&&t>-1){e.addToPlaylist(r,"before",t);n.splice(t,0,r)}};a.currentIndex=function(){return a.currentItem()};a.lastIndex=function(){return n.length-1};a.nextIndex=function(){var e=a.currentItem();if(-1===e);var r=a.lastIndex();if(e===r)return 0;else return Math.min(e+1,r)};a.previousIndex=function(){var e=a.currentItem();if(-1===e)return-1;if(0===e)return a.lastIndex();else return Math.max(e-1,0)};a.first=function(){if(!i){var e=a.currentItem(0);if(n.length)return n[e].originalValue||n[e];a.currentIndex_=-1}};a.last=function(){var e=a.currentItem(a.lastIndex());if(n.length)return n[e].originalValue||n[e];a.currentIndex_=-1};a.next=function(){if(!i)if(!e.adPlaying){var r=a.nextIndex();if(r!==a.currentIndex_){var t=a.currentItem(r);return n[t].originalValue||n[t]}}};a.new=function(r){n=r;e.newPlaylist(n)};a.previous=function(){if(!i)if(!e.adPlaying){var r=a.previousIndex();if(r!==a.currentIndex_){var t=a.currentItem(r);return n[t].originalValue||n[t]}}};a.autoadvance=function(e){setup(a.player_,e)};a.repeat=function(e){if(void 0===e)return a.repeat_;if("boolean"===typeof e){a.repeat_=!!e;return a.repeat_}else videojs.log.error("videojs-playlist: Invalid value for repeat",e)};a.list=function(){return n};a.sort=function(e){if(n.length){n.sort(e);if(!i);}};if(Array.isArray(r))a(r.slice(),t);else n=[];return a}var registerPlugin=videojs.registerPlugin||videojs.plugin;var plugin=function(e,r){this.ready(function(){factory(this,e,r);this.playlist.autoadvance(0);this.trigger("playlistready")})};registerPlugin("playlist",plugin);module.exports=plugin;